<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/@zendeskgarden/css-bedrock@7.0.21,npm/@zendeskgarden/css-utilities@4.3.0">
  <link rel="stylesheet" href="./main.css">
</head>
<body>
  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const client = ZAFClient.init();
    client.invoke('resize', { width: '100%', height: '200px' });
  </script>

  <script type="module">
    import { h, Component, render } from 'https://unpkg.com/preact?module';
    import htm from 'https://unpkg.com/htm?module';
  
    // Initialize htm with Preact
    const html = htm.bind(h);
  
    class App extends Component {
      async setTicketState() {
        const {'ticket.requester.id' : customerID, 'ticket.comments' : ticketComments } = await client.get(['ticket.requester.id', 'ticket.comments' ]);
        const commentsWithImages = ticketComments.filter(comment => comment.imageAttachments.length && comment.author.id === customerID);

        this.setState({customerID, commentsWithImages});
      }

      async reverseImageSearch() {
        this.setState({ searchRan: true, requestingImages: true })
        await this.setTicketState();

        const { commentsWithImages } = this.state;
        try {
          if(commentsWithImages.length) {
            const imageURLs = [];
            commentsWithImages.forEach(comment => {
              comment.imageAttachments.forEach(image => {
                imageURLs.push(image.contentUrl);
              });
            });

            const identicalImages = await axios.post('http://localhost:1818/api/imagefisher/', imageURLs );
            const { results, totalMatchedImages } = identicalImages.data;
            this.setState({ identicalImages: results, totalMatchedImages, requestingImages: false});

          } else {
            this.setState({ errorMessage: "Sorry, there's no images in the ticket from requester." })
          }
        } catch (error) {
          this.setState({errorMessage: 'Something went wrong fetching image results. Please try again later.'})
          console.error(error)
        }
      }
  
      render({ /* PROPS */ }, { 
        totalMatchedImages = 0, 
        customerID = '',
        searchRan = false,
        requestingImages = false, 
        commentsWithImages = [], 
        identicalImages = {},
        errorMessage = '' 
      }) {

        const Search = () => html`
        <button class="image-text hover-effect" onClick=${() => this.reverseImageSearch()}>
          <img src="./search.svg" alt="Search" />
          <h1>Click for Reverse Image Search</h1>
        </button>`

        const imagesAreGood = () => html`
        <div class="image-text">
          <img src="./thumbs-up.svg" alt="Thumbs up" />
          <h1>Fantastic!</h1>
          <h1>All images look original.</h1>
        </div>`

        return html`
          <div class="app ${totalMatchedImages === 0 ? 'center' : ''}">
            ${(!requestingImages && !totalMatchedImages && !searchRan) && html`<${Search} />` }
            ${(searchRan && !requestingImages && !totalMatchedImages) && html`<${imagesAreGood} />` }
            ${(searchRan && !requestingImages && totalMatchedImages) && html`<h1>Oh boy, I got some stuff to show you. ${totalMatchedImages} have simila images.</h1>` }
            ${requestingImages && html`<h1>Loading...</h1>` }
          </div>
        `;
      }

    }

    render(html`<${App} />`, document.body);
  </script>
</body>
</html>
